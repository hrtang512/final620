---
title: "Analysis"
format: html
---

```{r}
if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, gtsummary, kableExtra, broom, lme4, splines, ggeffects, nlme, splines)
```


```{r}
load('data/dat.rda')
dat = dat |>
  mutate(date_num = as.numeric(date))
```

### EDA
### Analysis from pset4

###Describe if COVID-19 became less or more virulent across the different periods.

Plot a trend plot for cases, hospitalizations and deaths for each state. Color by region. Plot rates per $100,000$ people. Place the plots on top of each other. Hint: Use `pivot_longer` and `facet_wrap`.
```{r}
dat |> 
  pivot_longer(c(cases, deaths, hosp), names_to = "outcome",values_to = "rate") |> 
  mutate(rate = rate / pop * 100000) |>
  ggplot(aes(date, rate, group = state, color = region)) + geom_line(alpha = 0.25) + 
  facet_wrap(~outcome, ncol = 1, scales = 'free_y') + theme_classic()
```

To determine when vaccination started and when most of the population was vaccinated, compute the percent of the US population (including DC and Puerto Rico) vaccinated by date. Do the same for the booster. Then plot both percentages.
```{r}
p <- dat |> group_by(date) |> summarise(pop = sum(pop), series = sum(series),
                                   booster = sum(booster)) |>
  pivot_longer(c(booster, series), names_to = "vaccine", values_to = "rate") |>
  mutate(rate = rate / pop * 100) |>
  ggplot(aes(date, rate, color = vaccine)) + geom_line() + theme_classic() + 
  ylab('percent vaccinated') + ggtitle('COVID 19 US Vaccination rates over time')
print(p)
```

### Divide the pandemic period, 2020/01/20 to 2023/05/11(first confirmed case of COVID-19, to the end of the public health emergency) into waves. For each period compute the deaths rates by state. Describe which states did better or worse during the different periods.
```{r}
library(tidyverse)
library(ggplot2)
library(tidytext)
# Divide the pandemic period into waves
dat <- dat |> 
  mutate(wave = case_when(
    date >= as.Date("2020-01-20") & date <= as.Date("2020-06-30") ~ "Wave 1",  # Initial outbreak
    # A sharp rise in death rates was observed, while reported cases remained low, 
    # likely reflecting insufficient testing capacity at the time.
    date >= as.Date("2020-07-01") & date <= as.Date("2021-05-30") ~ "Wave 2",  # first peak at 2020/12
    date >= as.Date("2021-06-01") & date <= as.Date("2021-10-31") ~ "Wave 3",  # Delta variant, second peak at 2021/09
    # The Delta variant was predominant during this period, with a marked increase in virulence.
    date >= as.Date("2021-11-01") & date <= as.Date("2022-03-31") ~ "Wave 4",  # Omicron variant, third peak at 2022/01
    # the Omicron wave saw the highest number of reported cases, but without a corresponding surge in hospitalizations and deaths,
    # indicating higher transmissibility but lower virulence.
    date >= as.Date("2022-04-01") & date <= as.Date("2023-05-11") ~ "Wave 5",  # Omicron subvariants (e.g.BQ.1, XBB),a small peak at 2022/12
    TRUE ~ NA_character_
  ))

death_summary <- dat |> 
  filter(!is.na(wave)) |> 
  group_by(state, wave, region) |> 
  summarise(total_deaths = sum(deaths, na.rm = TRUE),
            total_pop = mean(pop, na.rm = TRUE),
            death_rate = total_deaths / total_pop * 100000,
            .groups = "drop")

ggplot(death_summary, aes(x = reorder_within(state, death_rate, wave), 
                          y = death_rate, fill = region)) +
  geom_col() +
  facet_wrap(~wave, scales = "free_y") +
  coord_flip() +
  scale_x_reordered() + 
  labs(title = "COVID-19 Death Rate per 100,000 by State and Wave",
       x = "State", y = "Death Rate (per 100,000)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 3)) 

```



### LME Models

#### Prepare variables
```{r}
dat = dat |> 
  mutate(
    death_rate = deaths / pop * 1e5,
    case_rate = cases / pop * 1e5,
    hosp_rate = hosp / pop * 1e5,
    vax_rate = series / pop * 1e2,  # percent fully vaccinated
    booster_rate = booster / pop * 1e2  # percent boosted
  )

dat = dat |> 
  group_by(state) |> 
  arrange(date) |> 
  mutate(
    case_rate_lag2 = lag(case_rate, 2),
    hosp_rate_lag2 = lag(hosp_rate, 2)
  ) |> 
  ungroup()

dat_nofirst2 = dat |>
  filter(!is.na(case_rate_lag2), !is.na(hosp_rate_lag2))
```


##### Model 1 lmer
```{r}
model_1 = lmer(death_rate ~ case_rate + hosp_rate + vax_rate + booster_rate + ns(date_num, df = 5) + (1 | state), data = dat_nofirst2)

summary(model_1)


plot(ggpredict(model_1, terms="date_num [all]"))
AIC(model_1)
```



##### Model 2 lag cases hosp
```{r}
model_lag = lmer(death_rate ~ case_rate_lag2 + hosp_rate_lag2 + vax_rate + booster_rate + ns(date_num, df = 8) + (1 | state), data = dat_nofirst2)

summary(model_lag)

plot(ggpredict(model_lag, terms="date_num [all]"))
AIC(model_lag)
```

```{r}
aic_results = tibble(df = 2:10, AIC = NA_real_)

# Loop over degrees of freedom
for (i in 2:10) {
  model = lmer(death_rate ~ case_rate_lag2 + hosp_rate_lag2 + vax_rate + booster_rate +
                 ns(date_num, df = i) + (1 | state), data = dat_nofirst2)
  aic_results$AIC[aic_results$df == i] = AIC(model)
}

print(aic_results)
which.min(aic_results$AIC)
```



```{r}
fit = model_lag
state_to_plot = "CA"

# Remove rows with missing lagged predictors before prediction
dat_pred = dat |>
  filter(!is.na(case_rate_lag2), !is.na(hosp_rate_lag2)) |>
  mutate(predicted = predict(fit))

# Join predictions back to full data (optional, only if you want to keep NA rows in plotting)
dat_state = dat |> 
  filter(state == state_to_plot) |>
  left_join(dat_pred |> select(state, date, predicted), by = c("state", "date"))

# Plot observed vs predicted
ggplot(dat_state, aes(x = date)) +
  geom_point(aes(y = death_rate), color = "red", alpha = 0.6, size = 1.2) +  # Observed
  geom_line(aes(y = predicted), color = "blue", linewidth = 1) +  # Predicted
  labs(title = paste("Observed vs. Predicted Death Rate in", state_to_plot),
       y = "Death Rate (per 100,000)",
       x = "Date") +
  theme_minimal()
```

### Model Diagnostics
```{r}
plot(model_lag)  # base R method for lmer

resid_df = data.frame(
  fitted = fitted(model_lag),
  residuals = resid(model_lag)
)

ggplot(resid_df, aes(x = fitted, y = residuals)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_minimal() +
  labs(title = "Residuals vs. Fitted", x = "Fitted", y = "Residuals")
```

```{r}
qqnorm(resid(model_lag))
qqline(resid(model_lag), col = "blue")

data.frame(resid = resid(model_lag)) |> 
  ggplot(aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(color = "blue") +
  theme_minimal() +
  labs(title = "Q-Q Plot of Residuals")
```

### Excess death rate
```{r}
# Predict death rate using the lag model
dat_excess = dat_nofirst2 |> 
  mutate(predicted_death_rate = predict(model_lag),
         excess_death_rate = death_rate - predicted_death_rate)

# View a few rows
head(dat_excess |> select(state, date, death_rate, predicted_death_rate, excess_death_rate))
```

```{r}
state_to_plot = "CA"

dat_excess |> 
  filter(state == state_to_plot) |> 
  ggplot(aes(x = date, y = excess_death_rate)) +
  geom_line(color = "darkred") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(title = paste("Excess Death Rate Over Time in", state_to_plot),
       y = "Excess Death Rate (per 100,000)",
       x = "Date")
```


